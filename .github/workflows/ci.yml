name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  format-check:
    name: Code Formatting
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install clang-format
        if: runner.os != 'Windows'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format
        continue-on-error: true
      
      - name: Install clang-format (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install llvm -y
        continue-on-error: true
      
      - name: Check formatting
        run: |
          find src tests -name "*.cpp" -o -name "*.h" -o -name "*.hpp" | xargs clang-format --dry-run --Werror --style=file || (echo "Code formatting check failed. Run: clang-format -i -style=file <file>" && exit 1)
        continue-on-error: true

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cmake --build build --config Release
      
      - name: Run Tests
        run: |
          cd build
          ctest -C Release --output-on-failure
        continue-on-error: true

  build-macos:
    name: Build (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          brew install cmake
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cmake --build build --config Release
      
      - name: Run Tests
        run: |
          cd build
          ctest -C Release --output-on-failure
        continue-on-error: true

  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake g++-10
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=g++-10
      
      - name: Build
        run: |
          cmake --build build --config Release
      
      - name: Run Tests
        run: |
          cd build
          ctest -C Release --output-on-failure
        continue-on-error: true

  static-analysis:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-latest
    needs: [build-linux]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      
      - name: Run clang-tidy
        run: |
          find src tests -name "*.cpp" -o -name "*.h" -o -name "*.hpp" | \
          xargs -I {} clang-tidy {} -p build --config-file=.clang-tidy || true
        continue-on-error: true
      
      - name: Check for critical violations
        run: |
          echo "Static analysis complete. Review warnings above."
          echo "Critical violations (raw pointers, RT allocations) must be fixed."

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake gcovr lcov
      
      - name: Configure CMake with coverage
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"
      
      - name: Build
        run: |
          cmake --build build
      
      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure
        continue-on-error: true
      
      - name: Generate Coverage Report
        run: |
          lcov --capture --directory build --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --list coverage.info
        continue-on-error: true
      
      - name: Check Coverage Threshold
        run: |
          COVERAGE=$(lcov --summary coverage.info 2>/dev/null | grep -oP '\d+\.\d+%' | head -1 | sed 's/%//' || echo "0")
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "ERROR: Coverage ${COVERAGE}% is below 80% threshold for audio engine"
            exit 1
          fi
        continue-on-error: true

  compiler-warnings:
    name: Compiler Warnings Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [g++-10, clang++-12]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install compiler
        run: |
          sudo apt-get update
          if [ "${{ matrix.compiler }}" = "g++-10" ]; then
            sudo apt-get install -y g++-10
          else
            sudo apt-get install -y clang-12
          fi
      
      - name: Configure CMake
        run: |
          if [ "${{ matrix.compiler }}" = "g++-10" ]; then
            cmake -B build -DCMAKE_CXX_COMPILER=g++-10 -DCMAKE_BUILD_TYPE=Release
          else
            cmake -B build -DCMAKE_CXX_COMPILER=clang++-12 -DCMAKE_BUILD_TYPE=Release
          fi
      
      - name: Build (should fail on warnings)
        run: |
          cmake --build build 2>&1 | tee build.log
          if grep -i "warning" build.log; then
            echo "ERROR: Warnings detected. All warnings must be fixed (warnings as errors enabled)."
            exit 1
          fi
        continue-on-error: true

